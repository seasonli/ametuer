<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <title>出门问问 酒店预定</title>
  <link rel="stylesheet" href="http://mobvoi-one-box.oss.aliyuncs.com/web/css/chumenwenwen.2.0.css" >
  <link rel="stylesheet" href="http://mobvoi-one-box.oss.aliyuncs.com/web/css/chumenwenwen.hotel.css" >
  <script src="http://mobvoi-one-box.oss.aliyuncs.com/web/js/chumenwenwen.3.0.js"></script>
</head>

<body>
  <div class="wrapper" style="margin-top: -30px">
  </div>

  <script type="text/html" id="wrapper">
    <ul class="banner gotoDial" data-tel="{ answer.book_info.hotel_phone }">    
      <li class="cards_card" style="background: #21ac94; border: 0">
        <div class="cards_card_entire">
          <p><span class="layout-fleft layout-22px layout-bold layout-ellipsis" style="line-height: 22px; width: 80%">{ answer.book_info.hotel_name }</span><div class="clear"></div></p>
          <p><span class="layout-16px">{ answer.book_info.star_name }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="layout-12px">电话: { answer.book_info.hotel_phone }</span></p>
          <img src="http://mobvoi-one-box.oss.aliyuncs.com/web/img/phone.png" style="width: 32px" />
        </div>   
        </div>
      </li>
    </ul>
    <ul class="cards gotoMark">
      <li class="cards_card">
        <div class="cards_card_entire">
          <p>
            <span>{ answer.book_info.hotel_address }</span>
            <span class="layout-fright layout-right layout-666">
              <img src="http://mobvoi-one-box.oss.aliyuncs.com/web/img/gps.png" style="width: 12px" />
            </span>
          </p>   
        </div>
      </li>
    </ul>
    { if answer.valid == true }
      <ul class="cards">    
        <li class="cards_card">
          <div class="cards_card_img left">
            <p>
              <img src="{ answer.book_info.room_img }" />
            </p>   
          </div> 
          <div class="cards_card_img right">
            <p><span class="layout-16px">{ answer.book_info.room_name }</span></p>
            <p><span class="layout-orange layout-20px">今日 ￥{ answer.book_info.price }</span></p>
            <p><span class="layout-666">{ answer.book_info.bed_type }</span></p>         
            <p><span class="layout-12px layout-999">{ answer.book_info.room_description }</span></p>
          </div>      
          <div class="clear"></div>
        </li>
        <li class="cards_card">        
          <div class="cards_card_quarter left">
            <p>
              <label class="layout-green">到店</label>
            </p>
          </div>
          <div class="cards_card_quarter center">
            <p>
              <select id="checkin_month"></select>
            </p>
          </div>     
          <div class="cards_card_quarter center">
            <p>
              <select id="checkin_day"></select>
            </p>
          </div>
          <div class="cards_card_quarter right">
            <p>
              <select id="checkin_time">
                <option value="00:00:00">00:00</option>
                <option value="01:00:00">01:00</option>
                <option value="02:00:00">02:00</option>
                <option value="03:00:00">03:00</option>
                <option value="04:00:00">04:00</option>
                <option value="05:00:00">05:00</option>
                <option value="06:00:00">06:00</option>
                <option value="07:00:00">07:00</option>
                <option value="08:00:00">08:00</option>
                <option value="09:00:00">09:00</option>
                <option value="10:00:00">10:00</option>
                <option value="11:00:00">11:00</option>
                <option value="12:00:00">12:00</option>
                <option value="13:00:00">13:00</option>
                <option value="14:00:00">14:00</option>
                <option value="15:00:00">15:00</option>
                <option value="16:00:00">16:00</option>
                <option value="17:00:00">17:00</option>
                <option value="18:00:00">18:00</option>
                <option value="19:00:00">19:00</option>
                <option value="20:00:00">20:00</option>
                <option value="21:00:00">21:00</option>
                <option value="22:00:00">22:00</option>
                <option value="23:00:00">23:00</option>
                <option value="24:00:00">24:00</option>
              </select>
            </p>
          </div>
          <div class="clear"></div>
          <div class="cards_card_quarter left">
            <p><label class="layout-green">住店</label></p>
          </div>
          <div class="cards_card_quarter center">
            <p>
              <select id="numOfRooms">
                <option value="1">1 间</option>
                <option value="2">2 间</option>
                <option value="3">3 间</option>
                <option value="4">4 间</option>
                <option value="5">5 间</option>
              </select>
            </p>
          </div>
          <div class="cards_card_quarter center">
            <p>
              <select id="checkout_during">
                <option value="1">1 晚</option>
                <option value="2">2 晚</option>
                <option value="3">3 晚</option>
                <option value="4">4 晚</option>
                <option value="5">5 晚</option>
                <option value="6">6 晚</option>
                <option value="7">7 晚</option>
                <option value="8">8 晚</option>
                <option value="9">9 晚</option>
                <option value="10">10 晚</option>
                <option value="11">11 晚</option>
                <option value="12">12 晚</option>
                <option value="13">13 晚</option>
                <option value="14">14 晚</option>
                <option value="15">15 晚</option>
                <option value="16">16 晚</option>
                <option value="17">17 晚</option>
                <option value="18">18 晚</option>
                <option value="19">19 晚</option>
              </select>
            </p>
          </div>
          <div class="clear"></div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" placeholder="每间房须填写一人" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" placeholder="每间房须填写一人" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" placeholder="每间房须填写一人" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" placeholder="每间房须填写一人" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div class="cards_card_entire layout-right">
            <p>
              <span id="checkin_date" class="layout-bold"></span>
              ~
              <span id="checkout_date" class="layout-bold"></span>
              &nbsp;
              <span class="layout-bold">2</span>
              间
              <span class="layout-bold">2</span>
              晚
            </p>
            <p class="layout-16px">
              <span>总价：</span><span id="price" class="layout-bold layout-orange"></span>
              元
            </p>
          </div>
        </li>
        { if answer.book_info.guarantee_rule_desc }
          <li class="cards_card">
            <div class="cards_card_entire layout-12px">
              <p><span>{ answer.book_info.guarantee_rule_desc }</span></p>
            </div>
        { /if }     
        </li>
        <li class="cards_card">
          <div class="cards_card_entire layout-12px layout-666">
            <p><span>姓名与手机号仅用于短信客服确认，您的隐私不会被泄露，请放心填写。</span></p>
          </div>
          <div class="cards_card_form left layout-green layout-16px">
            <p><label>姓名</label></p>
          </div>
          <div class="cards_card_form right">
            <p><input type="text" id="username" value="{ answer.user_info.username }" /></p>
          </div>
          <div class="clear"></div>
          <div class="cards_card_form left layout-green layout-16px">
            <p><label>手机</label></p>
          </div>
          <div class="cards_card_form right">
            <p><input type="number" id="phone" value="{ answer.user_info.phone }" /></p>
          </div>
          <div class="clear"></div>
        </li>
        <li class="cards_card">
          <div class="cards_card_entire">
            <p><button id="pay" type="button">确认预定</button></p>
          </div>
          <div class="clear"></div>
        </li>
      </ul>
    { else }
      <ul class="cards">
        <li class="cards_card">
          <div class="cards_card_entire">
            <p><span>抱歉，该房间暂时无法预定</span></p>
          </div>
        </li>
      </ul>
    { /if }
  </script>

  <script>
    var response = ${content};

    var CMWW = new chumenwenwen();
    $(".wrapper").html(template.render("wrapper", response));
    if(browser.versions.android == true) {
      $("select").parent().addClass("select").addClass("android");
      $("[type='number']").addClass("android");
    } else if(browser.versions.ios == true) {
      $("select").parent().addClass("select").addClass("ios");
    }
    
    // Events
    $(".gotoDial").click(function() {
      CMWW.jump.dial($(this).attr("data-tel"));
    })    
    $(".gotoMark").click(function() {
      CMWW.jump.mark([[response.answer.book_info.hotel_name, response.answer.book_info.baidu_lat, response.answer.book_info.baidu_lng]]);
    })

    var year = new Date().getFullYear(), 
      month = new Date().getMonth() + 1,
      day = new Date().getDate();
    var monthHTML = "";    
    if(month < 12) {
      monthHTML = '<option value="' + month + '">' + month + '月</option><option value="' + (month + 1) + '">' + (month + 1) + '月</option>'
    } else {
      monthHTML = '<option value="' + month + '">' + month + '月</option><option value="1">1月</option>';
    }
    
    // Definite Form HTML
    $("#checkin_month").html(monthHTML);
    $("#checkin_day").html(formatDay(month + ""));

    // Intialize Form Value
    $("#checkin_time").val(response.answer.earliest_arrival_time.split(" ")[1]);
    $("#checkin_month").val(parseInt(response.answer.book_info.arrival_date.split("-")[1]));
    $("#checkin_day").val(parseInt(response.answer.book_info.arrival_date.split("-")[2]));
    if((Date.parse(response.answer.book_info.departure_date.replace(/-/g, "/")) - Date.parse(response.answer.book_info.arrival_date.replace(/-/g, "/"))) / 86400000 > 19) {
      $("#checkout_during").val(19);
    } else {
      $("#checkout_during").val((Date.parse(response.answer.book_info.departure_date.replace(/-/g, "/")) - Date.parse(response.answer.book_info.arrival_date.replace(/-/g, "/"))) / 86400000);
    }

    function formatDay(v) {
      var dayHTML = "", dayMax = "";
      switch(v) {
        case "1":
        case "3":
        case "5":
        case "7":
        case "8":
        case "10":
        case "12":
        dayMax = 31;
        break;
        case "4":
        case "6":
        case "9":
        case "11":
        dayMax = 30;
        break;
        case "2":
        if((year / 4) - Math.round((year / 4)) == 0) {
          dayMax = 29;
        } else {
          dayMax = 28;
        }
        break;        
      }
      var dayMin = "";
      if(month == v) {
        dayMin = day;
      } else {
        dayMin = 1;
      }
      for(i = dayMin; i <= dayMax; i ++) {
        dayHTML += '<option value="' + i + '">' + i + '日</option>';
      }   
      return dayHTML;
    }



    // This Global Variable Used to Calculate Total Price for Different Price for Every Night
    var pricePerRoom = response.answer.book_info.price;
    var pricePerRoomFlag = true;

    trackCheckin();
    trackCheckout();
    trackRoomNum();
    trackPrice();

    $("#checkin_month").change(function() {
      formatDay(this.value);
      trackCheckin();
      trackCheckout();
      calPricePerRoom();
    })
    $("#checkin_day").change(function() {
      trackCheckin();
      trackCheckout();
      calPricePerRoom();
    })    
    $("#checkout_during").change(function() {
      trackCheckout();
      calPricePerRoom();
    })
    $("#numOfRooms").change(function() {
      trackRoomNum();
      trackPrice();
    })
    $(".customers").eq(0).keyup(function() {
      $("#username").val($(this).val());
    })

    function calPricePerRoom() {
      CMWW.showDialog("正在获取价格...", "");
      pricePerRoomFlag = false;
      $.ajax({
        async: true,
        type: "POST",
        url: response.answer.book_info.price_get_url,
        data: {
          arrivalDate: $("#checkin_date").html(),
          departureDate: $("#checkout_date").html(),
          hotelId: response.answer.book_info.hotel_id,
          roomTypeId: response.answer.book_info.room_type_id,
          ratePlanId: response.answer.book_info.rate_plan_id
        },
        dataType: "json",
        success: function(rawData) {
          $(".dialog").remove();
          if(rawData.status == "success") {
            pricePerRoom = rawData.total_price;
            pricePerRoomFlag = true;
            trackPrice();
          } else {
            CMWW.showDialog("价格获取失败", ["content", ["请稍候再试"], [""]]);
          }
        },
        error: function() {
          $(".dialog").remove();
          CMWW.showDialog("价格获取失败", ["content", ["请稍候再试"], [""]]);
        },
      });      
    }
    function trackCheckin() {
      var checkin_date;
      if($("#checkin_month").val() < month) {
        year ++;
      }
      checkin_date = year + "-" + $("#checkin_month").val() + "-" + $("#checkin_day").val();
      $("#checkin_date").html(checkin_date);
    } 
    function trackCheckout() {
      var checkout_date = Date.parse(year + "/" + $("#checkin_month").val() + "/" + $("#checkin_day").val()) + $("#checkout_during").val() * 86400000;
      checkout_date = new Date(checkout_date).getFullYear() + "-" + (new Date(checkout_date).getMonth() + 1) + "-" + new Date(checkout_date).getDate();
      $("#checkout_date").html(checkout_date);
    }
    function trackRoomNum() {
      var customerNum = parseInt($("#numOfRooms").val());
      $(".customers").parent().parent().parent().css("display", "none");
      for(var i = 0; i < customerNum; i ++) {
        $(".customers").eq(i).parent().parent().parent().css("display", "block");
      }
    }
    function trackPrice() {
      $("#checkout_date").next().html($("#numOfRooms").val());
      $("#checkout_date").next().next().html($("#checkout_during").val());    
      $("#price").html(($("#numOfRooms").val() * pricePerRoom));
    }



    $("#pay").click(function() {
      var username = $.trim($("#username").val());
      var phone = $.trim($("#phone").val());
      var arrivalDate = $("#checkin_date").html();
      var departureDate = $("#checkout_date").html();
      var earliestArrivalTime = $("#checkin_date").html() + " " + $("#checkin_time").val();
      var numOfRooms = $("#numOfRooms").val();
      var customers = "";
      var price = $("#price").html();
      var customerFlag = true;
      if(pricePerRoomFlag == false) {
        CMWW.showDialog("价格获取失败", ["content", ["请稍候再试"], [""]]);
      } else {
        $(".customers").each(function(i) {
          if($(this).parent().parent().parent().css("display") != "none") {
            if(i != 0) {
              customers += ",";
            }
            var customer = $(this).val().match(/[\u4e00-\u9fa5]+/);
            if(customer != null) {
              customers += customer;
            } else {
              customerFlag = false;
              CMWW.showDialog("遗漏了住店人姓名", "");
              return false;
            }
          }
        });
        if(customerFlag == true) {
          if(username.length < 2) {
            CMWW.showDialog("请输入您的全名", "");
          } else if(phone.length != 11) {
            CMWW.showDialog("请输入正确的手机号", "");
          } else if(Date.parse((earliestArrivalTime.replace(/-/g, "/"))) - Date.parse(new Date()) < 0) {
            CMWW.showDialog("到店时间不能早于当前时间", "");
          } else {
            CMWW.showDialog("请等待，正在为你处理", "");
            $.ajax({
              async: true,
              type: "GET",
              url: response.answer.book_info.pay_url
                + "&arrivalDate=" + arrivalDate 
                + "&departureDate=" + departureDate
                + "&name=" + username
                + "&phone=" + phone
                + "&earliestArrivalTime=" + earliestArrivalTime
                + "&latestArrivalTime=" + response.answer.latest_arrival_time
                + "&numOfRooms=" + numOfRooms
                + "&customers=" + customers 
                + "&price=" + price,
              dataType: "json",
              success: function(rawData) {
                $(".dialog").remove();
                if (rawData.answer.status == "success") {
                  CMWW.showDialog("预定成功", ["content", [
                    "稍后会收到来自艺龙的短信确认", 
                    response.answer.book_info.hotel_name + "<br/>" + response.answer.book_info.room_name,
                    "总价：" + price + "<br/><br/>" + arrivalDate + " ~ " + departureDate
                  ], ["", "", ""]]);
                } else if (rawData.answer.status == "fail") {
                  CMWW.showDialog("预定失败", ["content", [rawData.answer.result], [""]]);
                }
              },
              error: function() {
                $(".dialog").remove();
                CMWW.showDialog("预定失败", ["content", ["由于网络原因，预定失败"], [""]]);
              },
            });
          }
        }
      }
    })
  </script>
</body>
</html>