<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <title>出门问问 酒店预定</title>
  <link rel="stylesheet" href="/css/chumenwenwen.2.0.css" >
  <link rel="stylesheet" href="/css/chumenwenwen.hotel.css" >
  <script src="/js/chumenwenwen.3.0.js"></script>
</head>

<body>
  <div class="wrapper" style="margin-top: -30px">
  </div>

  <script type="text/html" id="wrapper">
    <ul class="banner gotoDial" data-tel="{ answer.book_info.hotel_phone }">    
      <li class="cards_card" style="background: #21ac94; border: 0">
        <div class="cards_card_entire">
          <p><span class="layout-fleft layout-22px layout-bold layout-ellipsis" style="line-height: 22px; width: 80%">{ answer.book_info.hotel_name }</span><div class="clear"></div></p>
          <p><span class="layout-16px">{ answer.book_info.star_name }</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="layout-12px">电话: { answer.book_info.hotel_phone }</span></p>
          <img src="http://mobvoi-one-box.oss.aliyuncs.com/web/img/phone.png" style="width: 32px" />
        </div>   
        </div>
      </li>
    </ul>
    <ul class="cards gotoMark">
      <li class="cards_card">
        <div class="cards_card_entire">
          <p>
            <span>{ answer.book_info.hotel_address }</span>
            <span class="layout-fright layout-right layout-666">
              <img src="http://mobvoi-one-box.oss.aliyuncs.com/web/img/gps.png" style="width: 12px" />
            </span>
          </p>   
        </div>
      </li>
    </ul>
    { if answer.latest_arrival_time }
      <ul class="cards">    
        <li class="cards_card">
          <div class="cards_card_img left">
            <p>
              <img src="{ answer.book_info.room_img }" />
            </p>   
          </div> 
          <div class="cards_card_img right">
            <p><span class="layout-16px">{ answer.book_info.room_name }</span></p>
            <p><span class="layout-orange layout-20px">￥{ answer.book_info.price }</span></p>
            <p><span class="layout-666">{ answer.book_info.bed_type }</span></p>         
            <p><span class="layout-12px layout-999">{ answer.book_info.room_description }</span></p>
          </div>      
          <div class="clear"></div>
        </li>
        <li class="cards_card">        
          <div class="cards_card_quarter left">
            <p>
              <label class="layout-green">到店</label>
            </p>
          </div>
          <div class="cards_card_quarter center">
            <p>
              <select id="checkin_month"></select>
            </p>
          </div>     
          <div class="cards_card_quarter center">
            <p>
              <select id="checkin_day"></select>
            </p>
          </div>
          <div class="cards_card_quarter right">
            <p>
              <select id="checkin_time">
                <option value="00:00:00">00:00</option>
                <option value="01:00:00">01:00</option>
                <option value="02:00:00">02:00</option>
                <option value="03:00:00">03:00</option>
                <option value="04:00:00">04:00</option>
                <option value="05:00:00">05:00</option>
                <option value="06:00:00">06:00</option>
                <option value="07:00:00">07:00</option>
                <option value="08:00:00">08:00</option>
                <option value="09:00:00">09:00</option>
                <option value="10:00:00">10:00</option>
                <option value="11:00:00">11:00</option>
                <option value="12:00:00">12:00</option>
                <option value="13:00:00">13:00</option>
                <option value="14:00:00">14:00</option>
                <option value="15:00:00">15:00</option>
                <option value="16:00:00">16:00</option>
                <option value="17:00:00">17:00</option>
                <option value="18:00:00">18:00</option>
                <option value="19:00:00">19:00</option>
                <option value="20:00:00">20:00</option>
                <option value="21:00:00">21:00</option>
                <option value="22:00:00">22:00</option>
                <option value="23:00:00">23:00</option>
                <option value="24:00:00">24:00</option>
              </select>
            </p>
          </div>
          <div class="clear"></div>
          <div class="cards_card_quarter left">
            <p><label class="layout-green">住店</label></p>
          </div>
          <div class="cards_card_quarter center">
            <p>
              <select id="numOfRooms">
                <option value="1">1 间</option>
                <option value="2">2 间</option>
                <option value="3">3 间</option>
                <option value="4">4 间</option>
                <option value="5">5 间</option>
              </select>
            </p>
          </div>
          <div class="cards_card_quarter center">
            <p>
              <select id="checkout_during">
                <option value="1">1 晚</option>
                <option value="2">2 晚</option>
                <option value="3">3 晚</option>
                <option value="4">4 晚</option>
                <option value="5">5 晚</option>
                <option value="6">6 晚</option>
                <option value="7">7 晚</option>
                <option value="8">8 晚</option>
                <option value="9">9 晚</option>
                <option value="10">10 晚</option>
                <option value="11">11 晚</option>
                <option value="12">12 晚</option>
                <option value="13">13 晚</option>
                <option value="14">14 晚</option>
                <option value="15">15 晚</option>
                <option value="16">16 晚</option>
                <option value="17">17 晚</option>
                <option value="18">18 晚</option>
                <option value="19">19 晚</option>
              </select>
            </p>
          </div>
          <div class="clear"></div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" placeholder="每间房须填写一位住店人" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div>
            <div class="cards_card_form left layout-green layout-16px">
              <p><label>住店人</label></p>
            </div>
            <div class="cards_card_form right">
              <p><input type="text" class="customers" value="{ answer.user_info.username }" /></p>
            </div>
            <div class="clear"></div>  
          </div>
          <div class="cards_card_entire layout-right">
            <p>
              <span id="checkin_date" class="layout-bold"></span>
              ~
              <span id="checkout_date" class="layout-bold"></span>
              &nbsp;
              <span class="layout-bold">2</span>
              间
              <span class="layout-bold">2</span>
              晚
            </p>
            <p class="layout-16px">
              <span>总价：</span><span id="price" class="layout-bold layout-orange"></span>
              元
            </p>
          </div>
        </li>
        { if answer.book_info.guarantee_rule_desc }
          <li class="cards_card">
            <div class="cards_card_entire layout-12px">
              <p><span>{ answer.book_info.guarantee_rule_desc }</span></p>
            </div>
        { /if }     
        </li>
        <li class="cards_card">
          <div class="cards_card_entire layout-12px layout-666">
            <p><span>姓名与手机号仅用于短信客服确认，您的隐私不会被泄露，请放心填写。</span></p>
          </div>
          <div class="cards_card_form left layout-green layout-16px">
            <p><label>姓名</label></p>
          </div>
          <div class="cards_card_form right">
            <p><input type="text" id="username" value="{ answer.user_info.username }" /></p>
          </div>
          <div class="clear"></div>
          <div class="cards_card_form left layout-green layout-16px">
            <p><label>手机</label></p>
          </div>
          <div class="cards_card_form right">
            <p><input type="number" id="phone" value="{ answer.user_info.phone }" /></p>
          </div>
          <div class="clear"></div>
        </li>
        <li class="cards_card">
          <div class="cards_card_entire">
            <p><button id="pay" type="button">确认预定</button></p>
          </div>
          <div class="clear"></div>
        </li>
      </ul>
    { else }
      <ul class="cards">
        <li class="cards_card">
          <div class="cards_card_entire">
            <p><span>抱歉，该房间暂时无法预定</span></p>
          </div>
        </li>
      </ul>
    { /if }
  </script>

  <script>
//    var response = ${content};
    var response = {"answer":{"book_info":{"arrival_date":"2014-02-12","baidu_lat":"30.586593793686387","baidu_lng":"114.28765502853176","bed_type":"大床（180cm*200cm）","booking_rule_desc":"您预订了N间房，请您提供不少于N位的入住客人姓名\n","departure_date":"2014-02-13","guarantee_rule_desc":"担保条件：在11.08.29至50.12.31 入住 如果在19:00至6:00到店，或预订房量超过4间，需要您提供信用卡担保。客人入住日18:00点前可以变更取消，之后无法变更取消，如未入住，将扣除第一晚房费作为违约金。\n","hotel_address":"江汉区前进一路燕马新村7号（京汉大道与前进一路交叉口）","hotel_name":"7天连锁酒店（武汉京汉大道前进一路店）","hotel_phone":"027-85864998","pay_url":"http://m.mobvoi.com/search/pay/hotel?starName=%E7%BB%8F%E6%B5%8E%E5%9E%8B%E9%85%92%E5%BA%97&query=%E6%AD%A6%E6%B1%89%E5%9B%BD%E9%99%85%E4%BC%9A%E5%B1%95%E4%B8%AD%E5%BF%83%E9%99%84%E8%BF%91%E6%9C%89%E6%B2%A1%E6%9C%89%E5%AE%BE%E9%A6%86&appkey=debug&cityCode=1801&ratePlan=%E5%90%AB%E6%97%A9&hotelId=31801200&version=10010&city=%E6%AD%A6%E6%B1%89&gcjLng=114.281120896&roomDesc=%E5%85%8D%E8%B4%B9%E4%B8%8A%E7%BD%91%2C%E5%AE%BD%E5%B8%A6&hotelAddress=%E6%B1%9F%E6%B1%89%E5%8C%BA%E5%89%8D%E8%BF%9B%E4%B8%80%E8%B7%AF%E7%87%95%E9%A9%AC%E6%96%B0%E6%9D%917%E5%8F%B7%EF%BC%88%E4%BA%AC%E6%B1%89%E5%A4%A7%E9%81%93%E4%B8%8E%E5%89%8D%E8%BF%9B%E4%B8%80%E8%B7%AF%E4%BA%A4%E5%8F%89%E5%8F%A3%EF%BC%89&hotelName=7%E5%A4%A9%E8%BF%9E%E9%94%81%E9%85%92%E5%BA%97%EF%BC%88%E6%AD%A6%E6%B1%89%E4%BA%AC%E6%B1%89%E5%A4%A7%E9%81%93%E5%89%8D%E8%BF%9B%E4%B8%80%E8%B7%AF%E5%BA%97%EF%BC%89&roomName=%E5%95%86%E5%8A%A1%E5%A4%A7%E5%BA%8A%E6%88%BF&hotelPhone=027-85864998&user_id=&query_type=pay&baiduLat=30.586593793686387&roomTypeId=0003&bookingRuleDesc=%E6%82%A8%E9%A2%84%E8%AE%A2%E4%BA%86N%E9%97%B4%E6%88%BF%EF%BC%8C%E8%AF%B7%E6%82%A8%E6%8F%90%E4%BE%9B%E4%B8%8D%E5%B0%91%E4%BA%8EN%E4%BD%8D%E7%9A%84%E5%85%A5%E4%BD%8F%E5%AE%A2%E4%BA%BA%E5%A7%93%E5%90%8D%0A&gcjLat=30.580786703&ratePlanId=127848&customerType=Chinese&task=public.hotel&device_id=&need_recommend=false&guaranteeRuleDesc=%E6%8B%85%E4%BF%9D%E6%9D%A1%E4%BB%B6%EF%BC%9A%E5%9C%A811.08.29%E8%87%B350.12.31+%E5%85%A5%E4%BD%8F+%E5%A6%82%E6%9E%9C%E5%9C%A819%3A00%E8%87%B36%3A00%E5%88%B0%E5%BA%97%EF%BC%8C%E6%88%96%E9%A2%84%E8%AE%A2%E6%88%BF%E9%87%8F%E8%B6%85%E8%BF%874%E9%97%B4%EF%BC%8C%E9%9C%80%E8%A6%81%E6%82%A8%E6%8F%90%E4%BE%9B%E4%BF%A1%E7%94%A8%E5%8D%A1%E6%8B%85%E4%BF%9D%E3%80%82%E5%AE%A2%E4%BA%BA%E5%85%A5%E4%BD%8F%E6%97%A518%3A00%E7%82%B9%E5%89%8D%E5%8F%AF%E4%BB%A5%E5%8F%98%E6%9B%B4%E5%8F%96%E6%B6%88%EF%BC%8C%E4%B9%8B%E5%90%8E%E6%97%A0%E6%B3%95%E5%8F%98%E6%9B%B4%E5%8F%96%E6%B6%88%EF%BC%8C%E5%A6%82%E6%9C%AA%E5%85%A5%E4%BD%8F%EF%BC%8C%E5%B0%86%E6%89%A3%E9%99%A4%E7%AC%AC%E4%B8%80%E6%99%9A%E6%88%BF%E8%B4%B9%E4%BD%9C%E4%B8%BA%E8%BF%9D%E7%BA%A6%E9%87%91%E3%80%82%0A&address=%E4%B8%AD%E5%9B%BD%2C%E4%B8%8A%E6%B5%B7%2C%E4%B8%8A%E6%B5%B7%E5%B8%82%2C%E6%B5%A6%E4%B8%9C%E6%96%B0%E5%8C%BA%2C%E6%B5%A6%E5%9F%8E%E8%B7%AF%2C%2C31.235267851523%2C121.51697499967&roomImgUrl=http%3A%2F%2Fwww.elongstatic.com%2Fhotels%2Fpic%2Froom_no.png&msg_id=&bedType=%E5%A4%A7%E5%BA%8A%EF%BC%88180cm*200cm%EF%BC%89&method=&output=json&baiduLng=114.28765502853176","price":"197","rate_plan":"含早","room_description":"免费上网,宽带","room_img":"http://www.elongstatic.com/hotels/pic/room_no.png","room_name":"商务大床房","star_name":"经济型酒店"},"earliest_arrival_time":"2014-02-12 16:00:00","latest_arrival_time":"2014-02-12 17:00:00","user_info":{"phone":"","username":""},"valid":"true"},"appkey":"debug","location":{"city":"上海市","country":"中国","lat":31.235267851523,"lng":121.51697499967,"province":"上海","street":"浦城路","streetNumber":"undefined","sublocality":"浦东新区"},"msg_id":"undefined","params":[{"key":"city","keyname":"城市","value":"武汉"},{"key":"checkin","keyname":"入住日期","value":"2014-02-12"},{"key":"checkout","keyname":"退房日期","value":"2014-02-13"}],"query":"undefined","query_type":"book","remote_ip":"undefined","status":"success","task":"public.hotel","taskName":"找酒店","user_id":"undefined","version":"10010"}

    var CMWW = new chumenwenwen();
    $(".wrapper").html(template.render("wrapper", response));
    if(browser.versions.android == true) {
      $("select").parent().addClass("select").addClass("android");
      $("[type='number']").addClass("android");
    } else if(browser.versions.ios == true) {
      $("select").parent().addClass("select").addClass("ios");
    }
    
    // Events
    $(".gotoDial").click(function() {
      CMWW.jump.dial($(this).attr("data-tel"));
    })    
    $(".gotoMark").click(function() {
      CMWW.jump.mark([[response.answer.book_info.hotel_name, response.answer.book_info.baidu_lat, response.answer.book_info.baidu_lng]]);
    })

    var year = new Date().getFullYear(), 
      month = new Date().getMonth() + 1,
      day = new Date().getDate();
    var monthHTML = "";    
    if(month < 12) {
      monthHTML = '<option value="' + month + '">' + month + '月</option><option value="' + (month + 1) + '">' + (month + 1) + '月</option>'
    } else {
      monthHTML = '<option value="' + month + '">' + month + '月</option><option value="1">1月</option>';
    }
    
    // Definite Form HTML
    $("#checkin_month").html(monthHTML);
    $("#checkin_day").html(formatDay(month + ""));

    // Intialize Form Value
    $("#checkin_time").val(response.answer.earliest_arrival_time.split(" ")[1]);
    $("#checkin_month").val(parseInt(response.answer.book_info.arrival_date.split("-")[1]));
    $("#checkin_day").val(parseInt(response.answer.book_info.arrival_date.split("-")[2]));
    if((Date.parse(response.answer.book_info.departure_date.replace(/-/g, "/")) - Date.parse(response.answer.book_info.arrival_date.replace(/-/g, "/"))) / 86400000 > 19) {
      $("#checkout_during").val(19);
    } else {
      $("#checkout_during").val((Date.parse(response.answer.book_info.departure_date.replace(/-/g, "/")) - Date.parse(response.answer.book_info.arrival_date.replace(/-/g, "/"))) / 86400000);
    }

    function formatDay(v) {
      var dayHTML = "", dayMax = "";
      switch(v) {
        case "1":
        case "3":
        case "5":
        case "7":
        case "8":
        case "10":
        case "12":
        dayMax = 31;
        break;
        case "4":
        case "6":
        case "9":
        case "11":
        dayMax = 30;
        break;
        case "2":
        if((year / 4) - Math.round((year / 4)) == 0) {
          dayMax = 29;
        } else {
          dayMax = 28;
        }
        break;        
      }
      var dayMin = "";
      if(month == v) {
        dayMin = day;
      } else {
        dayMin = 1;
      }
      for(i = dayMin; i <= dayMax; i ++) {
        dayHTML += '<option value="' + i + '">' + i + '日</option>';
      }   
      return dayHTML;
    }

    trackCheckin();
    trackCheckout();
    trackRoomNum();
    trackPrice();




    $("#checkin_month").change(function() {
      formatDay(this.value);
      trackCheckin();
      trackCheckout();
      trackPrice();
    })
    $("#checkin_day").change(function() {
      trackCheckin();
      trackCheckout();
      trackPrice();
    })    
    $("#checkout_during").change(function() {
      trackCheckout();
      trackPrice();
    })
    $("#numOfRooms").change(function() {
      trackRoomNum();
      trackPrice();
    })
    $(".customers").eq(0).keyup(function() {
      $("#username").val($(this).val());
    })

    function trackCheckin() {
      var checkin_date;
      if($("#checkin_month").val() < month) {
        year ++;
      }
      checkin_date = year + "-" + $("#checkin_month").val() + "-" + $("#checkin_day").val();
      $("#checkin_date").html(checkin_date);
    } 
    function trackCheckout() {
      var checkout_date = Date.parse(year + "/" + $("#checkin_month").val() + "/" + $("#checkin_day").val()) + $("#checkout_during").val() * 86400000;
      checkout_date = new Date(checkout_date).getFullYear() + "-" + (new Date(checkout_date).getMonth() + 1) + "-" + new Date(checkout_date).getDate();
      $("#checkout_date").html(checkout_date);
    }
    function trackRoomNum() {
      var customerNum = parseInt($("#numOfRooms").val());
      $(".customers").parent().parent().parent().css("display", "none");
      for(var i = 0; i < customerNum; i ++) {
        $(".customers").eq(i).parent().parent().parent().css("display", "block");
      }
    }
    function trackPrice() {
      $("#checkout_date").next().html($("#numOfRooms").val());
      $("#checkout_date").next().next().html($("#checkout_during").val());    
      $("#price").html(($("#numOfRooms").val() * $("#checkout_during").val() * response.answer.book_info.price));
    }



    $("#pay").click(function() {
      var username = $.trim($("#username").val());
      var phone = $.trim($("#phone").val());
      var arrivalDate = $("#checkin_date").html();
      var departureDate = $("#checkout_date").html();
      var earliestArrivalTime = $("#checkin_date").html() + " " + $("#checkin_time").val();
      var numOfRooms = $("#numOfRooms").val();
      var customers = "";
      var price = $("#price").html();
      var customerFlag = true;
      $(".customers").each(function(i) {
        if($(this).parent().parent().parent().css("display") != "none") {
          if(i != 0) {
            customers += ",";
          }
          var customer = $(this).val().match(/[\u4e00-\u9fa5]+/);
          if(customer != null) {
            customers += customer;
          } else {
            customerFlag = false;
            CMWW.showDialog("遗漏了住店人姓名", ["", ["遗漏了住店人姓名"], [""]]);    
          }
        }
      });
      if(customerFlag) {
        if(username.length < 2) {
          CMWW.showDialog("请输入您的全名", ["", ["请输入您的全名"], [""]]);
        } else if(phone.length != 11) {
          CMWW.showDialog("请输入正确的手机号", "");
        } else if(Date.parse((latestArrivalTime.replace(/-/g, "/"))) - Date.parse(new Date()) < 0) {
          CMWW.showDialog("到店时间不能早于当前时间", "");
        } else {
          CMWW.showDialog("请等待，正在为你处理", "");
          $.ajax({
            async: false,
            type: "GET",
            url: response.answer.book_info.pay_url + "&arrivalDate=" + arrivalDate 
              + "&departureDate=" + departureDate
              + "&name=" + username
              + "&phone=" + phone
              + "&earliestArrivalTime=" + earliestArrivalTime
              + "&price=" + price,
            dataType: "json",
            success: function(rawData) {
              $(".dialog").remove();
              if (rawData.answer.status == "success") {
                CMWW.showDialog("预定成功", ["content", [
                  "稍后会收到来自艺龙的短信确认", 
                  response.answer.book_info.hotel_name + "<br/>" + response.answer.book_info.room_name,
                  "总价：" + price + "<br/><br/>" + arrivalDate + " ~ " + departureDate
                ], ["", "", ""]]);
              } else if (rawData.answer.status == "fail") {
                CMWW.showDialog("预定失败", ["content", [rawData.answer.result], [""]]);
              }
            },
            error: function() {
              $(".dialog").remove();
              CMWW.showDialog("预定失败", ["content", ["由于网络原因，预定失败"], [""]]);
            },
          });
        }
      }
    })
  </script>
</body>
</html>