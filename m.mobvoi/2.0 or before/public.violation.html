<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalabel=0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <title>出门问问 查违章</title> 
  <link rel="stylesheet" href="http://mobvoi-one-box.oss.aliyuncs.com/web/css/chumenwenwen.2.0.css" />
  <script src="http://mobvoi-one-box.oss.aliyuncs.com/web/js/chumenwenwen.3.0.js"></script>
</head>

<body>
  <div class="wrapper">
  </div>

  <script type="text/html" id="wrapper_violation_create">
    <ul class="cards">
      <li class="cards_card result">
        <div class="cards_card_entire">
          <p><span class="layout-444">您只需输入一次车牌信息，之后将为您自动查询违章信息</span></p>
        </div>
      </li>
      <form id="form" method="GET">
        <input name="output" value="html_page" type="hidden" />
        <input name="request" value="create" type="hidden" />
        <input name="user_id" type="hidden" />
        <input name="appkey" type="hidden" />
        <input name="version" type="hidden" />
        <input name="msg_id" type="hidden" />
        <input name="cityname" type="hidden" />
        <li class="cards_card">
          <div class="cards_card_double left">
            <p><input id="cityname" type="text" onkeydown="if(event.keyCode==13) {gotoDetail(this.value)}" placeholder="所在城市" /></p>
          </div>
          <div class="cards_card_double right">
            <p><button type="button" onClick="gotoDetail($('#cityname').val())">确认所在城市</button></p>
          </div>
          <div class="clear"></div>
        </li>
        <li class="cards_card" id="detail" style="display: none">
          <div class="clear"></div>
          <div class="cards_card_form left">
            <p><label>&nbsp;&nbsp;&nbsp;&nbsp;车牌号</label></p>
          </div>
          <div class="cards_card_form right">
            <p><input name="hphm" type="text" /></p>
          </div>
          <div class="clear"></div>
          <div class="cards_card_form left">
            <p><label>车辆类型</label></p>
          </div>
          <div class="cards_card_form right">
            <p>
              <select name="hpzl">
                <option value="02">小型车</option>
                <option value="01">大型车</option>
                <option value="03">使馆汽车</option>
                <option value="04">领馆汽车</option>
                <option value="05">境外汽车</option>
                <option value="06">外籍汽车</option>
                <option value="07">两,三轮摩托车</option>
                <option value="08">轻便摩托车</option>
                <option value="09">使馆摩托车</option>
                <option value="10">领馆摩托车</option>
                <option value="11">境外摩托车</option>
                <option value="12">外籍摩托车</option>
                <option value="13">低速车</option>
                <option value="14">拖拉机</option>
                <option value="15">挂车</option>
                <option value="16">教练汽车</option>
                <option value="17">教练摩托车</option>
                <option value="18">试验汽车</option>
                <option value="19">试验摩托车</option>
                <option value="20">临时入境汽车</option>
                <option value="21">临时入境摩托车</option>
                <option value="22">临时行驶车</option>
                <option value="23">警用汽车</option>
                <option value="24">警用摩托</option>
                <option value="99">其他</option>
              </select>
            </p>
          </div>
          <div class="clear"></div>
          <div id="wrapperInput"></div>
          <div class="cards_card_entire">
            <p><input type="button" value="确认" onClick="submitForm()" /></p>
          </div>
          <div class="clear"></div>
        </li>
      </form>
    </ul>
  </script>

  <script type="text/html" id="wrapper_violation_result">
    <ul class="cards">
      <li class="cards_card result">
        <div class="cards_card_entire">
          <p><span class="layout-444">为您搜索到 “违章信息”</span></p>
          <p><span id="total" class="layout-999"> 条结果</span></p>
        </div>
      </li>
      <li class="cards_card">
        <div class="cards_card_entire">
          <p><button onClick="window.location.href='{answer[0].url}'" class="layout-bgreen layout-fff">点击更新我的车牌信息</button></p>
        </div>
      </li>
      { each answer[0].content.result.lists as val i }
        <li class="cards_card">
          <div class="cards_card_entire">
            <p><span class="layout-19px">{ val.date }</span></p>
            <p><span class="layout-999">{ val.area }</span></p> 
            <p><span class="layout-17px layout-green">扣分：{ val.fen }</span></p> 
            <p><span class="layout-17px layout-orange">罚款：{ val.money }</span></p>    
            <p><span>{ val.act }</span></p> 
          </div>
        </li>
      { /each }
    </ul>
  </script>

  <script type="text/html" id="wrapper_violation_complied">
    <ul class="cards">
      <li class="cards_card result">
        <div class="cards_card_entire">
          <p><span class="layout-444">我们在系统中已经有了您的信息，您不需要重复输入你的车牌信息</span></p>
        </div>
      </li>
      <li class="cards_card">
        <div class="cards_card_entire">
          <p><button onClick="window.location.href='{answer[0].url}'" class="layout-bgreen layout-fff">点击查看我的违章信息</button></p>
        </div>
      </li>   
    </ul>
  </script>

  <script type="text/html" id="wrapper_violation_error">
    <ul class="cards">
      <li class="cards_card result">
        <div class="cards_card_entire">
          <p><span class="layout-444">抱歉，出现了一点问题，我们会尽快修复！</span></p>
        </div>
      </li>   
    </ul>
  </script>

  <script type="text/html" id="wrapper_violation_timeout">
    <ul class="cards">
      <li class="cards_card result">
        <div class="cards_card_entire">
          <p><span class="layout-444">抱歉，请求超时，您可以刷新页面重试</span></p>
        </div>
      </li>   
    </ul>
  </script>

  <script>
    // Judge Net Environment
    if (window.location.host == "localhost.m.mobvoi") {
      var urlPrefix = "/m.mobvoi";
    } else if (window.location.host == "m.mobvoi.com") {
      var urlPrefix = "";
    } else {
      var urlPrefix = "/mobvoibackendcontroller";
    }    

    var verify = {};

//    var response = ${content};
    var response = {"session_id":"public.violation@1cef9959e48b4d8c4996e20cdd91a39e","location":{"street":"武东路","province":"上海市","lng":121.49982640557423,"streetNumber":"undefined","sublocality":"杨浦区","lat":31.308912471391192,"city":"上海市","country":"中国"},"status":"success","task":"public.violation","query":"违章","remote_ip":"124.127.127.175","answer":[{"content":"user not found","status":404,"request":"html_city","url":"http://m.mobvoi.com/search/pc/violation?hphm=&appkey=wechat_browser&classno=&version=10000&city=&address=%E4%B8%AD%E5%9B%BD%2C%E4%B8%8A%E6%B5%B7%E5%B8%82%2C%E4%B8%8A%E6%B5%B7%E5%B8%82%2C%E6%9D%A8%E6%B5%A6%E5%8C%BA%2C%E6%AD%A6%E4%B8%9C%E8%B7%AF%2Cundefined%2C31.308912471391192%2C121.49982640557423&hpzl=&registno=&request=html_city&msg_id=&engineno=&user_id=&query_type=pcc&cityname=&output=html_page"}],"appkey":"wechat_chumenwenwen","location_option":{"content":"","is_need":false},"params":[],"taskName":"查违章","version":"10000","msg_id":"","user_id":"","query_type":""};

    switch (response.answer[0].status) {
      case 404: // 未建立用户档案->显示表单
        $(".wrapper").html($("#wrapper_violation_create").html());
      break;
      case 200: // 查询成功
        if (response.answer[0].content != "update html") { // 查询成功->显示结果
          $(".wrapper").html(template.render("wrapper_violation_result", response));
          if (response.answer[0].content.resultcode == "200") {
            if (response.answer[0].content.result.lists.length > 0) {
              $("#total").prepend(response.answer[0].content.result.lists.length);
            } else {
              $("ul").html('<li class="cards_card result"><div class="cards_card_entire"><p><span class="layout-444">您目前没有违章记录</span></p></div></li><li class="cards_card"><div class="cards_card_entire"><p><button onClick="window.location.href=\'' + response.answer[0].url + '\'" class="layout-bgreen layout-fff">点击更新我的车牌信息</button></p></div></li>')
            }
          } else { // example 6
            $("ul").html('<li class="cards_card result"><div class="cards_card_entire"><p><span class="layout-444">' + response.answer[0].content.reason + '</span></p></div></li><li class="cards_card"><div class="cards_card_entire"><p><button onClick="window.location.href=\'' + response.answer[0].url + '\'" class="layout-bgreen layout-fff">点击更新我的车牌信息</button></p></div></li>')  // example6
          }
        } else { // 更新表单
          $(".wrapper").html($("#wrapper_violation_create").html());
          $("#cityname").val(response.answer[0].info.cityname); 
          $('[name="cityname"]').val(response.answer[0].info.cityname); 
          initialDetail(response.answer[0].info.cityname); 
          $('[name="request"]').val("update");
          $('[name="hphm"]').val(response.answer[0].info.hphm);
          $('[name="hpzl"]').val(response.answer[0].info.hpzl);
        }
        break;
      case 403: // 重复创建用户
        $(".wrapper").html(template.render("wrapper_violation_complied", response)); // example 5
        break;
      case 505: // 超时
        $(".wrapper").html(template.render("wrapper_violation_timeout", response)); // example 5
        break;        
      default: // other error code
        $(".wrapper").html(template.render("wrapper_violation_error", response));
    }
    $("#form").attr("action", urlPrefix + "/search/pc/violation");
    $('[name="user_id"]').val(response.user_id);
    $('[name="msg_id"]').val(response.msg_id);
    $('[name="version"]').val(response.version);
    $('[name="appkey"]').val(response.appkey);

    if(browser.versions.android == true) {
      $("select").parent().addClass("select").addClass("android");
      $("[type='number']").addClass("android");
    } else if(browser.versions.ios == true) {
      $("select").parent().addClass("select").addClass("ios");
    }
    // Render in Browser
    if((browser.versions.mobile == true && browser.versions.chrome == true) || browser.versions.dolphin == true || (browser.versions.gecko == true && browser.versions.mobile == false)) {
      $(".wrapper").before('<div class="header"><input id="query" class="header_input" type="text" placeholder="出门问问" /><nav id="querySearch" class="header_search" onTouchStart="$(this).addClass(\'touch\')" onTouchEnd="$(this).removeClass(\'touch\')"></nav></div>');
      $(".wrapper").css({"margin-top": parseInt($(".wrapper").css("margin-top")) + 48 + "px"});
      if(browser.versions.dolphin == true) {
        $(".wrapper").after("<div class='footer'></div>");
        $(".wrapper").css({"margin-bottom": parseInt($(".wrapper").css("margin-bottom")) + 48 + "px"});
        $(".footer").prepend("<nav class='footer_center' id='dolphinSpeak'></nav>");
        $(".footer_center").css({"background-image": "url(http://mobvoi-one-box.oss.aliyuncs.com/web/img/speak.png)", "left": document.body.clientWidth / 2 - 20 + "px"});
      }
      new chumenwenwen.search("query", "querySearch", "test1085");
      $("#query").val("查违章");
    }

    function gotoDetail(value) {
      delete verify.lastdigitofclassno;
      delete verify.lastdigitofengineno;
      delete verify.lastdigitofregistno;
      if (value != "") {
        $.ajax ({
          async: false,
          type: "GET",
          url: urlPrefix + "/search/pc/violation?request=html_create&user_id=" + response.user_id + "&msg_id=" + response.msg_id + "&version=" + response.version + "&appkey=" + response.appkey + "&cityname=" + $.trim(value),
          dataType: "json",
          success: function (rawData) {
            if (rawData.answer[0].status == 504) {
              alert("抱歉，城市暂不支持")
            } else {
              $('[name="cityname"]').val($("#cityname").val());
              $('[name="hphm"]').val("");
              $("#wrapperInput").html("");
              $("#detail").show();
              for (var idx in rawData.answer[0].info.need) {
                var placeholder;
                if(idx == "lastdigitofclassno" || idx == "lastdigitofengineno" || idx == "lastdigitofengineno") {
                  if(idx == "lastdigitofclassno") {
                    placeholder = "车架号";
                    verify[idx] = -1;
                  } else if(idx == "lastdigitofengineno") {
                    placeholder = "发动机号";
                    verify[idx] = -1;
                  } else if(idx == "lastdigitofengineno") {
                    placeholder = "登记证书号";
                    verify[idx] = -1;
                  }                  
                  if (rawData.answer[0].info.need[idx] != 0) {
                    verify[idx] = rawData.answer[0].info.need[idx];
                    placeholder = placeholder + "后" + rawData.answer[0].info.need[idx] + "位";
                  }
                  $("#wrapperInput").append('<div class="cards_card_form left"><p><label>' + placeholder + '</label></p></div><div class="cards_card_form right"><p><input name="' + idx + '" type="text" /></p></div>');
                }
              }
              $("#wrapperInput").append('<div class="clear"></div>');
            }
          },
        })
      }
    }
    function initialDetail(value) {
      delete verify.lastdigitofclassno;
      delete verify.lastdigitofengineno;
      delete verify.lastdigitofregistno;
      if (value != "") {
        $.ajax ({
          async: false,
          type: "GET",
          url: urlPrefix + "/search/pc/violation?request=html_create&user_id=" + response.user_id + "&msg_id=" + response.msg_id + "&version=" + response.version + "&appkey=" + response.appkey + "&cityname=" + $.trim(value),
          dataType: "json",
          success: function (rawData) {
            if (rawData.answer[0].status == 504) {
              alert("抱歉，城市暂不支持")
            } else {
              $('[name="cityname"]').val($("#cityname").val());
              $('[name="hphm"]').val("");
              $("#wrapperInput").html("");
              $("#detail").show();
              for (var idx in rawData.answer[0].info.need) {
                var placeholder;
                if(idx == "lastdigitofclassno" || idx == "lastdigitofengineno" || idx == "lastdigitofengineno") {
                  if(idx == "lastdigitofclassno") {
                    placeholder = "车架号";
                    verify[idx] = -1;
                  } else if(idx == "lastdigitofengineno") {
                    placeholder = "发动机号";
                    verify[idx] = -1;
                  } else if(idx == "lastdigitofengineno") {
                    placeholder = "登记证书号";
                    verify[idx] = -1;
                  }                  
                  if (rawData.answer[0].info.need[idx] != 0) {
                    verify[idx] = rawData.answer[0].info.need[idx];
                    placeholder = placeholder + "后" + rawData.answer[0].info.need[idx] + "位";
                  }
                  var idx1 = idx.split("lastdigitof")[1];
                  $("#wrapperInput").append('<div class="cards_card_form left"><p><label>' + placeholder + '</label></p></div><div class="cards_card_form right"><p><input value="' + response.answer[0].info.need[idx1] + '" name="' + idx + '" type="text" /></p></div>');
                }
              }
              $("#wrapperInput").append('<div class="clear"></div>');
            }
          },
        })
      }
    }    
    function submitForm() {
      if($.trim($('[name="hphm"]').val()) == "") {
        alert("请输入您的车牌号");
      } else if(verify.lastdigitofclassno && ($.trim($('[name="lastdigitofclassno"]').val()) == "" || (verify.lastdigitofclassno > -1 && $.trim($('[name="lastdigitofclassno"]').val()).length != verify.lastdigitofclassno))) {
        alert("请输入正确的" + $('[name="lastdigitofclassno"]').parent().parent().parent().html().split("<label>")[1].split("</label>")[0]);
      } else if(verify.lastdigitofengineno && ($.trim($('[name="lastdigitofengineno"]').val()) == "" || (verify.lastdigitofengineno > -1 && $.trim($('[name="lastdigitofengineno"]').val()).length != verify.lastdigitofengineno))) {
        alert("请输入正确的" + $('[name="lastdigitofengineno"]').parent().parent().parent().html().split("<label>")[1].split("</label>")[0]);
      } else if(verify.lastdigitofclassno && ($.trim($('[name="lastdigitofclassno"]').val()) == "" || (verify.lastdigitofclassno > -1 && $.trim($('[name="lastdigitofclassno"]').val()).length != verify.lastdigitofclassno))) {
        alert("请输入正确的" + $('[name="lastdigitofclassno"]').parent().parent().parent().html().split("<label>")[1].split("</label>")[0]);
      } else {
        $('[name="lastdigitofclassno"]').attr("name", "classno");
        $('[name="lastdigitofengineno"]').attr("name", "engineno");
        $('[name="lastdigitofregistno"]').attr("name", "registno");
        document.getElementById("form").submit();   
      }    
    }
  </script>
</body>
</html>